<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title> - Hugo Whisper Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="/favicon.png">

  
  
  <link rel="stylesheet" href="/css/style.min.aad43d4ecb69a264f2539b89d7f779d5f3cdff22e7585fe5fc3c77272f1c2696.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="/"><img alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="/"><img alt="Logo" src="/images/logo-mobile.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            



<div class="docs-menu">
  <div class="form-input-group mb-3 pr-3">
    <label>Version</label>
    <div class="custom_select">
      <select onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);">
        
          
            <option value="/docs/">docs</option>
          
        
          
            <option value="/v1.5/" selected>v1.5</option>
          
        
      </select>
    </div>
  </div>
  <ul class="toc">
    
    <h1 id="table-of-contents">Table of contents</h1>
<ul>
<li><a href="README.md">Introduction</a></li>
</ul>
<h2 id="prologue">Prologue</h2>
<ul>
<li><a href="prologue/introduction-and-installaton.md">Introduction and Installaton</a></li>
<li><a href="prologue/contributing-guide.md">Contributing Guide</a></li>
<li><a href="prologue/how-to-contribute.md">How To Contribute</a></li>
<li><a href="prologue/release-cycle.md">Release Cycle</a></li>
</ul>
<h2 id="whats-new">What&rsquo;s New</h2>
<ul>
<li><a href="whats-new/masonite-1.3.md">Masonite 1.3</a></li>
<li><a href="whats-new/masonite-1.4.md">Masonite 1.4</a></li>
<li><a href="whats-new/masonite-1.5.md">Masonite 1.5</a></li>
</ul>
<h2 id="upgrade-guide">Upgrade Guide</h2>
<ul>
<li><a href="upgrade-guide/masonite-1.3-to-1.4.md">Masonite 1.3 to 1.4</a></li>
<li><a href="upgrade-guide/masonite-1.4-to-1.5.md">Masonite 1.4 to 1.5</a></li>
</ul>
<h2 id="the-basics">The Basics</h2>
<ul>
<li><a href="the-basics/routing.md">Routing</a></li>
<li><a href="the-basics/controllers.md">Controllers</a></li>
<li><a href="the-basics/views.md">Views</a></li>
<li><a href="the-basics/requests.md">Requests</a></li>
<li><a href="the-basics/static-files.md">Static Files</a></li>
<li><a href="the-basics/helper-functions.md">Helper Functions</a></li>
</ul>
<h2 id="the-craft-command">The Craft Command</h2>
<ul>
<li><a href="the-craft-command/introduction.md">Introduction</a></li>
<li><a href="the-craft-command/creating-commands.md">Creating Commands</a></li>
<li><a href="the-craft-command/authentication-system.md">Authentication System</a></li>
</ul>
<h2 id="architectural-concepts">Architectural Concepts</h2>
<ul>
<li><a href="architectural-concepts/request-lifecycle.md">Request Lifecycle</a></li>
<li><a href="architectural-concepts/service-providers.md">Service Providers</a></li>
<li><a href="architectural-concepts/service-container.md">Service Container</a></li>
</ul>
<h2 id="advanced">Advanced</h2>
<ul>
<li><a href="advanced/middleware.md">Middleware</a></li>
<li><a href="advanced/validation.md">Validation</a></li>
<li><a href="advanced/creating-packages.md">Creating Packages</a></li>
<li><a href="advanced/extending-classes.md">Extending Classes</a></li>
<li><a href="advanced/creating-a-mail-driver.md">Creating a Mail Driver</a></li>
<li><a href="advanced/sessions.md">Sessions</a></li>
</ul>
<h2 id="useful-features">Useful Features</h2>
<ul>
<li><a href="useful-features/template-caching.md">Template Caching</a></li>
<li><a href="useful-features/mail.md">Mail</a></li>
<li><a href="useful-features/uploading.md">Uploading</a></li>
<li><a href="useful-features/view-composers-and-sharing.md">View Composers and Sharing</a></li>
<li><a href="useful-features/caching.md">Caching</a></li>
<li><a href="useful-features/broadcasting.md">Broadcasting</a></li>
<li><a href="useful-features/queues-and-jobs.md">Queues and Jobs</a></li>
<li><a href="useful-features/compiling-assets.md">Compiling Assets</a></li>
</ul>
<h2 id="security">Security</h2>
<ul>
<li><a href="security/authentication.md">Authentication</a></li>
<li><a href="security/encryption.md">Encryption</a></li>
<li><a href="security/csrf-protection.md">CSRF Protection</a></li>
</ul>
<h2 id="orator-orm">Orator ORM</h2>
<ul>
<li><a href="https://orator-orm.com/docs/0.9/basic_usage.html">Basic Usage</a></li>
<li><a href="https://orator-orm.com/docs/0.9/query_builder.html">Query Builder</a></li>
<li><a href="https://orator-orm.com/docs/0.9/orm.html">ORM</a></li>
<li><a href="https://orator-orm.com/docs/0.9/pagination.html">Pagination</a></li>
<li><a href="https://orator-orm.com/docs/0.9/schema_builder.html">Schema Builder</a></li>
<li><a href="orator-orm/database-migrations.md">Database Migrations</a></li>
<li><a href="https://orator-orm.com/docs/0.9/collections.html">Collections</a></li>
</ul>
<h2 id="managers-and-drivers">Managers and Drivers</h2>
<ul>
<li><a href="managers-and-drivers/about-managers.md">About Managers</a></li>
<li><a href="managers-and-drivers/about-drivers.md">About Drivers</a></li>
<li><a href="managers-and-drivers/contracts.md">Contracts</a></li>
</ul>
<h2 id="official-packages">Official Packages</h2>
<ul>
<li><a href="https://masoniteframework.gitbooks.io/masonite-entry/content/">Masonite Entry</a></li>
<li><a href="http://billing.masoniteproject.com">Masonite Billing</a></li>
</ul>
<h2 id="creating-your-first-blog">Creating Your First Blog</h2>
<ul>
<li><a href="creating-your-first-blog/introduction.md">Introduction</a></li>
<li><a href="creating-your-first-blog/part-1-creating-our-first-route.md">Part 1 - Creating Our First Route</a></li>
<li><a href="creating-your-first-blog/part-2-creating-our-first-controller.md">Part 2 - Creating Our First Controller</a></li>
<li><a href="creating-your-first-blog/part-3-designing-our-blog.md">Part 3 - Designing Our Blog</a></li>
<li><a href="creating-your-first-blog/part-4-migrations.md">Part 4 - Migrations</a></li>
<li><a href="creating-your-first-blog/part-5-models.md">Part 5 - Models</a></li>
<li><a href="creating-your-first-blog/part-3-authentication.md">Part 3 - Authentication</a></li>
</ul>
    
  </ul>
</div>


          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title"></h1>
<div class="content ">
  <h1 id="masonite-clerk">Masonite Clerk</h1>
<h1 id="introduction">Introduction</h1>
<p>Masonite Clerk provides a very expressive and simple syntax to start charging your users with Stripe. In addition to being incredibly easy to setup, Clerk can handle charges, subscriptions, cancellation, subscription swapping, subscription prorating and customer creation. You&rsquo;re going to love it.</p>
<h2 id="configuration">Configuration</h2>
<h3 id="pip">Pip</h3>
<p>First we&rsquo;ll need to install Clerk on our machine. To do this simply run:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ pip install clerk
</code></pre></div><h3 id="adding-the-configuration-file">Adding The Configuration File</h3>
<p>Masonite uses the <code>config/payment.py</code> configuration file. Conveniently, Clerk comes with a <code>publish</code> command we can use to create this.</p>
<h3 id="note-virtual-environment">NOTE: Virtual Environment</h3>
<p><strong>If you are in a virtual environment, <strong><code>craft publish</code></strong> will not have access to your virtual environment dependencies. In order to fix this, we can add our site packages to our <strong><code>config/packages.py</code></strong> config file</strong></p>
<p>If you are in a virtual environment then go to your <code>config/packages.py</code> file and add your virtual environments site_packages folder to the <code>SITE_PACKAGES</code> list. Your <code>SITE_PACKAGES</code> list may look something like:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">SITE_PACKAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;venv/lib/python3.6/site-packages&#39;</span>
<span class="p">]</span>
</code></pre></div><p>This will allow <code>craft publish</code> to find our dependencies installed on our virtual environment.</p>
<h3 id="publishing-masonite-clerk">Publishing Masonite Clerk</h3>
<p>If you are in a virtual environment it is important you add your virtual environmentâ€™s <code>site_packages</code> directory to the <code>config/packages.py</code> file.</p>
<p>We can now run:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ craft publish clerk
</code></pre></div><p>This will create a new configuration file in <code>config/payment.py</code></p>
<h3 id="api-keys">API Keys</h3>
<p>You&rsquo;ll notice in this new <code>config/payment.py</code> file we have a config setting that looks like:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">PROCESSORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;stripe&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STRIPE_PUBLISHABLE&#39;</span><span class="p">),</span>
        <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STRIPE_SECRET&#39;</span><span class="p">),</span>
        <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;usd&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Our API keys for <code>key</code>, and <code>secret</code> should reside in our <code>.env</code> file. Just create two entries in your <code>.env</code> file that looks like:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">STRIPE_PUBLISHABLE=pk_test_Hghus...
STRIPE_SECRET=sk_test_KIsnsh...
</code></pre></div><p>These API keys can be found in your Stripe dashboard.</p>
<h3 id="database-migrations">Database Migrations</h3>
<p>We&rsquo;ll assume you want to add billable services to your users so we&rsquo;ll just add a few fields to our users table. Just run:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ craft migration add_stripe_to_users --table users
</code></pre></div><p>Inside this migrations <code>up()</code> method we&rsquo;ll just copy these columns in:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;stripe_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;card_brand&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;card_last_four&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s1">&#39;trial_ends_at&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
</code></pre></div><p>Next we&rsquo;ll do the same thing but will be creating a subscriptions table.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ craft migration create_subscriptions_table --create subscriptions
</code></pre></div><p>Now just copy and paste these migrations in:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;stripe_id&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;stripe_plan&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s1">&#39;trial_ends_at&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s1">&#39;ends_at&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">timestamps</span><span class="p">()</span>
</code></pre></div><p>Now that we&rsquo;ve finished our migrations lets migrate them into our database:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ craft migrate
</code></pre></div><h3 id="billable-model">Billable Model</h3>
<p>Lastly we&rsquo;ll add a special class to our users table so we can gain access to a lot of Clerk methods on our model. Let&rsquo;s open our User model and import a new Billable model as well as inherit from it:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">orator</span> <span class="kn">import</span> <span class="n">DatabaseManager</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">config.database</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="c1"># New Billable Import</span>
<span class="kn">from</span> <span class="nn">clerk.Billable</span> <span class="kn">import</span> <span class="n">Billable</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Billable</span><span class="p">):</span>

    <span class="n">__fillable__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="n">__auth__</span> <span class="o">=</span> <span class="s1">&#39;email&#39;</span>
</code></pre></div><p>That&rsquo;s it! You&rsquo;re all ready to start charging and subscribing users!</p>
<h2 id="subscriptions-and-charges">Subscriptions and Charges</h2>
<p><strong>NOTE: All references to token are stripe tokens which are sent by the request after a form submission. For testing purposes you can use the &lsquo;tok_amex&rsquo; string which will create a test AMEX card so we don&rsquo;t have to keep submitting forms</strong></p>
<p>To charge a user $1. All amounts are in cents. So below we are charging our user 1000 cents (or $10)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).charge(token, 1000)
</code></pre></div><p>To create a customer</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).customer(token)
</code></pre></div><p>To subcribe a user to a plan</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribe(&#39;database_plan&#39;, &#39;stripe_plan&#39;, token)
</code></pre></div><p>To get the actual subscription model from our payment processor. This is great if you want to make some changes to the subscription manually and then <code>.save()</code> it after.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).getSubscription()
</code></pre></div><p>To cancel the current subscription</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).cancel()
</code></pre></div><p>To get the Customer object from our payment processor. This is great if you want to make changes to the customer object manually and then <code>.save()</code> it</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).getCustomer()
</code></pre></div><p>To delete the user as a customer:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).deleteCustomer()
</code></pre></div><p>To swap the current processor plan for a new plan. This will prorate the current plan by default.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).swap(&#39;new_stripe_plan&#39;)
</code></pre></div><p>If you do not wish to prorate the user. Read more about prorating from the payment processor you are using.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).noProrate().swap(&#39;new_stripe_plan&#39;)
</code></pre></div><p>Check if a user is subscribed to a specific stripe plan</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribedToPlan(&#39;stripe_plan&#39;)
</code></pre></div><p>Check to see if a user is subscribed to any one of the plans specified</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribedToPlan([&#39;stripe-plan1&#39;, &#39;stripe-plan2&#39;])
</code></pre></div><p>To see if the user is currently subscribed (to any plan)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribed()
</code></pre></div><p>To see if a user is subscribed to a specific plan (a local plan, not a stripe plan)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribed(&#39;main-plan&#39;)
</code></pre></div><p>To see if a user is subscribed to any of the plans specified (local plans, not a stripe plans)</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">User.find(1).subscribed([&#39;main-plan&#39;, &#39;second-plan&#39;])
</code></pre></div>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

  
  
  
    
  


</body>

</html>
